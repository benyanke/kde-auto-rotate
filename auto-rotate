#!/bin/bash

#
# auto-rotate the screen and pointers
# copyright 2018 Don Bowman (db@donbowman.ca)
# Licensed under Apache License, Version 2.0

pointers=$(xinput list | awk '/Virtual core pointer/ { printing=1 } /Virtual core keyboard/ { printing=0} { if (printing) { gsub(".*id=",""); print $1 } }')

rotate_cursor() {
    for p in $pointers
    do
        xinput set-prop $p "Coordinate Transformation Matrix" $*
    done
}


monitor-sensor | while read line ; do

  # Ignore any lines which are not rotation events
  echo "$line" | grep "orientation" &> /dev/null
  export ret="$?"
  if [ "$ret" -ne "0" ] ; then
    echo "SKIP"
    continue
  else

  # Don't rotate if external monitor connected
  nscreens=$(xrandr  | grep -c " connected")
  if [ $nscreens != 1 ]; then
      line=normal
  fi

   # Handle each case
   if [[ $line == *"normal"* ]] ; then
            xrandr --output eDP-1 --rotate normal
            rotate_cursor 1 0 0 0 1 0 0 0 1
    elif [[ $line == *"bottom-up"* ]] ; then
            xrandr --output eDP-1 --rotate inverted
            rotate_cursor -1 0 1 0 -1 1 0 0 1
    elif [[ $line == *"right-up"* ]] ; then
            xrandr --output eDP-1 --rotate right
            rotate_cursor 0 1 0 -1 0 1 0 0 1
    elif [[ $line == *"left-up"* ]] ; then
            xrandr --output eDP-1 --rotate left
            rotate_cursor 0 -1 1 1 0 0 0 0 1
    else
      echo "Undefined action"
    fi

  fi
done

exit 0
